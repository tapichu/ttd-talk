<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>TDD</title>

  <link rel="stylesheet" href="./css/reset.css" type="text/css"/>
  <link rel="stylesheet" href="./css/showoff.css" type="text/css"/>

  <script type="text/javascript" src="./js/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="./js/jquery.cycle.all.js"></script>
	<script type="text/javascript" src="./js/jquery-print.js"></script>
  <script type="text/javascript" src="./js/jquery.batchImageLoad.js"></script>

  <script type="text/javascript" src="./js/jquery.doubletap-0.1.js"></script>

  <script type="text/javascript" src="./js/fg.menu.js"></script>
  <script type="text/javascript" src="./js/showoff.js"></script>
  <script type="text/javascript" src="./js/jTypeWriter.js"> </script>
  <script type="text/javascript" src="./js/sh_main.min.js"></script>
  <script type="text/javascript" src="./js/core.js"></script>
  <script type="text/javascript" src="./js/showoffcore.js"></script>

  <link type="text/css" href="./css/fg.menu.css" media="screen" rel="stylesheet" />
  <link type="text/css" href="./css/theme/ui.all.css" media="screen" rel="stylesheet" />
  <link type="text/css" href="./css/sh_style.css" rel="stylesheet" >

  
    <link rel="stylesheet" href="file/style.css" type="text/css"/>
  

  
    <script type="text/javascript" src="file/scripts.js"></script>
  

  <script type="text/javascript">
  $(function(){
    setupPreso(false, './');
  });
  </script>
</head>

<body>


<a tabindex="0" href="#search-engines" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="navmenu"><span class="ui-icon ui-icon-triangle-1-s"></span>slides</a>
<div id="navigation" class="hidden"></div>

<div id="help">
  <table>
    <tr><td class="key">space, &rarr;</td><td>next slide</td></tr>
    <tr><td class="key">&larr;</td><td>previous slide</td></tr>
    <tr><td class="key">d</td><td>debug mode</td></tr>
    <tr><td class="key">## &lt;ret&gt;</td><td>go to slide #</td></tr>
    <tr><td class="key">c</td><td>table of contents (vi)</td></tr>
    <tr><td class="key">f</td><td>toggle footer</td></tr>
    <tr><td class="key">r</td><td>reload slides</td></tr>
    <tr><td class="key">z</td><td>toggle help (this)</td></tr>
  </table>
</div>

<div class="buttonNav">
  <input type="submit" onClick="prevStep();" value="prev"/>
  <input type="submit" onClick="nextStep();" value="next"/>
</div>

<div id="preso">loading presentation...</div>
<div id="footer">
  <span id="slideInfo"></span>
  <span id="debugInfo"></span>
  <span id="notesInfo"></span>
</div>

<div id="slides" class="offscreen" style="display:none;">
<div class="slide" data-transition="none"><div class="content" ref="unit/01_unit-tests/1">
<h1>TDD: Test-driven development</h1></div>
</div><div class="slide" data-transition="scrollUp"><div class="content bullets incremental" ref="unit/01_unit-tests/2">
<h1>Objetivos</h1>

<ul>
<li>Mejorar la calidad / robustez</li>
<li>Reducir el n&#xFA;mero de bugs</li>
<li>Reducir la fase de pruebas de aceptaci&#xF3;n</li>
<li>Tener confianza a la hora de hacer cambios o darle mantenimiento a la aplicaci&#xF3;n</li>
</ul>
</div>
</div><div class="slide" data-transition="scrollUp"><div class="content subsection" ref="unit/01_unit-tests/3">
<h1>Unit tests</h1></div>
</div><div class="slide" data-transition="scrollUp"><div class="content bullets incremental" ref="unit/01_unit-tests/4">
<h1>Pruebas unitarias</h1>

<ul>
<li>Automatizar las pruebas</li>
<li>Probar por "pedacitos"</li>
<li>Definir "est&#xE1;ndares" o "especificaciones"</li>
<li>Sin dependencias</li>
</ul>
</div>
</div><div class="slide" data-transition="scrollUp"><div class="content bullets incremental" ref="unit/01_unit-tests/5">
<h1>Escenarios</h1>

<ul>
<li>Happy path</li>
<li>Par&#xE1;metros de entrada incorrectos</li>
<li>Errores en servicios / dependencias</li>
<li>Manejo de excepciones</li>
<li>Etc.</li>
</ul>
</div>
</div><div class="slide" data-transition="scrollUp"><div class="content execute small" ref="unit/01_unit-tests/6">
<h1>Ejemplo</h1>

<pre class="sh_java"><code>@Transactional
@Override
public Mesorregion update(Mesorregion entity) {
    if (entity != null) {
        entity.setFechaModificacion(new Date());
        return super.update(entity);
    } else {
        throw new IllegalArgumentException(
                DaoErrors.NULL_PARAM);
    }
}</code></pre></div>
</div><div class="slide" data-transition="scrollUp"><div class="content execute" ref="unit/01_unit-tests/7">
<h1>Mocks</h1>

<pre class="sh_java"><code>Mockery context = new JUnit4Mockery();
EntityManager em =
    context.mock(EntityManager.class);
Query query = context.mock(Query.class);</code></pre></div>
</div><div class="slide" data-transition="scrollUp"><div class="content execute small" ref="unit/01_unit-tests/8">
<h1>Happy path</h1>

<pre class="sh_java"><code>@Test
public void update() {
    final Long id = new Long(1);
    final Mesorregion mesorregion = 
            new Mesorregion(id, "Centro");

    context.checking(new Expectations() {{
        oneOf (em).merge(mesorregion);
            will(returnValue(mesorregion));
    }});

    Mesorregion result =
            mesorregionDao.update(mesorregion);
    assertNotNull(result);
    assertNotNull(result.getFechaModificacion());
}</code></pre></div>
</div><div class="slide" data-transition="scrollUp"><div class="content execute small" ref="unit/01_unit-tests/9">
<h1>Par&#xE1;metros / Excepciones</h1>

<pre class="sh_java"><code>@Test
public void updateNull() {
    try {
        mesorregionDao.update(null);
        fail("Deber&#xED;a lanzar una excepci&#xF3;n");
    } catch (IllegalArgumentException e) {
        assertEquals(DaoErrors.NULL_PARAM, e.getMessage());
    }
}</code></pre></div>
</div><div class="slide" data-transition="scrollUp"><div class="content execute smaller" ref="unit/01_unit-tests/10">
<h1>Excepciones de dependencias</h1>

<pre class="sh_java"><code>@Test
public void addMesorregionException() {
    final Mesorregion mesorregion = new Mesorregion();

    context.checking(new Expectations() {{
        oneOf (mesorregionDao).create(mesorregion);
            will(throwException(
                new DataAccessResourceFailureException("Error")));
    }});

    try {
        carreterasService.addMesorregion(mesorregion);
        fail("Deber&#xED;a haber lanzado una excepci&#xF3;n");
    } catch (ServiceException e) {
        assertEquals(
            CarreterasServiceErrors.MESORREGION_CREATE,
            e.getMessage());
    }
}</code></pre></div>
</div><div class="slide" data-transition="scrollUp"><div class="content execute smaller" ref="unit/01_unit-tests/11">
<h1>L&#xF3;gica "interna"</h1>

<pre class="sh_java"><code>context.checking(new Expectations() {{
    oneOf (em).createNamedQuery("mesorregion.active.findAll");
        will(returnValue(query));
    oneOf (query).setMaxResults(AbstractJpaDao.DEFAULT_PAGE_SIZE);
        will(returnValue(query));
    oneOf (query).setFirstResult(0);
        will(returnValue(query));
    oneOf (query).getResultList();
        will(returnValue(results));
    oneOf (em).createQuery(
        with(allOf(
            containsString("COUNT"),
            containsString("Mesorregion"))));
        will(returnValue(query));
    oneOf (query).getSingleResult();
    will(returnValue(count));
}});

SearchResult&lt;Mesorregion&gt; resultados =
    mesorregionDao.findAll(new PaginatedSearchArg(-5, -5));</code></pre></div>
</div><div class="slide" data-transition="scrollUp"><div class="content execute" ref="unit/01_unit-tests/12">
<h1>C&#xF3;mo ejecutar las pruebas</h1>

<h2>Deben terminar en <em>Test</em></h2>

<pre class="sh_shell"><code>mvn test

mvn test -pl dao -am</code></pre></div>
</div><div class="slide" data-transition="scrollUp"><div class="content subsection" ref="integration/01_integration-tests/1">
<h1>Integration Tests</h1></div>
</div><div class="slide" data-transition="scrollUp"><div class="content bullets incremental" ref="integration/01_integration-tests/2">
<h1>Pruebas de integraci&#xF3;n</h1>

<ul>
<li>Probar con dependencias:</li>
<li>Contexto de spring</li>
<li>Base de datos</li>
<li>Transacciones (JTA)</li>
<li>Etc.</li>
</ul>
</div>
</div><div class="slide" data-transition="scrollUp"><div class="content bullets incremental" ref="integration/01_integration-tests/3">
<h1>Escenarios</h1>

<ul>
<li>Validaci&#xF3;n de entradas y salidas</li>
<li>Probar f&#xED;sicamente en la BD</li>
<li>Revisar el resultado de las transacciones</li>
<li>Pruebas de rendimiento</li>
<li>Etc.</li>
</ul>
</div>
</div><div class="slide" data-transition="scrollUp"><div class="content execute smaller" ref="integration/01_integration-tests/4">
<h1>Ejemplo</h1>

<pre class="sh_java"><code>@Transactional
@Override
public Mesorregion create(Mesorregion mesorregion) {
    if (mesorregion != null) {
        mesorregion.setFechaCreacion(new Date());
        mesorregion.setActivo(true);

        Map&lt;String, Object&gt; params = new HashMap&lt;String, Object&gt;();
        params.put("nombre", mesorregion.getNombre());
        List&lt;Mesorregion&gt; mesorregiones =
            queryNamed("mesorregion.inactive.findByName", params);
        if (mesorregiones != null &amp;&amp; !mesorregiones.isEmpty()) {
            mesorregion.setId(mesorregiones.get(0).getId());
            mesorregion.setFechaModificacion(null);
            return super.update(mesorregion);
        }
        return super.create(mesorregion);
    } else {
        throw new IllegalArgumentException(DaoErrors.NULL_PARAM);
    }
}</code></pre></div>
</div><div class="slide" data-transition="scrollUp"><div class="content execute" ref="integration/01_integration-tests/5">
<h1>Preparar la BD</h1>

<pre class="sh_java"><code>@Override
public String getXmlDataFile() {
    return "src/test/resources/" +
        "META-INF/data/mesorregion.xml";
}</code></pre></div>
</div><div class="slide" data-transition="scrollUp"><div class="content execute small" ref="integration/01_integration-tests/6">
<h1>Validar Salidas</h1>

<pre class="sh_java"><code>@Test
public void create() {
    Mesorregion mesorregion = new Mesorregion("Este");
    mesorregion = mesorregionDao.create(mesorregion);

    assertNotNull(mesorregion.getId());
    assertEquals(1l, mesorregion.getId().longValue());
    assertEquals("Este", mesorregion.getNombre());
    assertTrue(mesorregion.isActivo());
    // Debe tener fecha de creaci&#xF3;n
    assertNotNull(mesorregion.getFechaCreacion());
    assertNull(mesorregion.getFechaModificacion());

    assertEquals(4, mesorregionDao.findAll().size());
    // Evitar 'false positives'!!!
    entityManager.flush();
}</code></pre></div>
</div><div class="slide" data-transition="scrollUp"><div class="content execute small" ref="integration/01_integration-tests/7">
<h1>Validar errores / transacciones</h1>

<pre class="sh_java"><code>@Test
@Rollback(true)
@ExpectedException(value=DataAccessException.class)
public void createNull() {
    mesorregionDao.create(null);
}</code></pre></div>
</div><div class="slide" data-transition="scrollUp"><div class="content execute small" ref="integration/01_integration-tests/8">
<h1>Probar rendimiento</h1>

<pre class="sh_java"><code>@Test
@Repeat(1000)
@Timed(200)
public void create() {
    Mesorregion mesorregion = new Mesorregion("Este");
    mesorregion = mesorregionDao.create(mesorregion);

    assertNotNull(mesorregion.getId());
    assertEquals(1l, mesorregion.getId().longValue());
    assertEquals("Este", mesorregion.getNombre());
    assertTrue(mesorregion.isActivo());
    // Debe tener fecha de creaci&#xF3;n
    assertNotNull(mesorregion.getFechaCreacion());
    assertNull(mesorregion.getFechaModificacion());

    assertEquals(4, mesorregionDao.findAll().size());
    entityManager.flush();
}</code></pre></div>
</div><div class="slide" data-transition="scrollUp"><div class="content execute" ref="integration/01_integration-tests/9">
<h1>C&#xF3;mo ejecutar las pruebas</h1>

<h2>Deben terminar en <em>IT</em></h2>

<pre class="sh_shell"><code>mvn verify

mvn verify -pl dao -am

mvn verify -pl dao -am -Dit.test=*Meso*IT

mvn verify -Dit.test=*Meso*IT,*Esta*IT</code></pre></div>
</div><div class="slide" data-transition="scrollUp"><div class="content subsection" ref="ci/01_continuous-integration/1">
<h1>Continuous Integration</h1></div>
</div><div class="slide" data-transition="scrollUp"><div class="content bullets incremental" ref="ci/01_continuous-integration/2">
<h1>Integraci&#xF3;n continua</h1>

<ul>
<li>Automatizar la ejecuci&#xF3;n de pruebas:</li>
<li>De integraci&#xF3;n</li>
<li>De estr&#xE9;s</li>
<li>Automatizar el despliegue de la aplicaci&#xF3;n</li>
</ul>
</div>
</div><div class="slide" data-transition="scrollUp"><div class="content bullets incremental" ref="ci/01_continuous-integration/3">
<h1>Jenkins</h1>

<ul>
<li>Una tarea para el proyecto principal</li>
<li>Una tarea para cada fork</li>
<li>Polling a GitHub (ejecuci&#xF3;n autom&#xE1;tica)</li>
<li>Notificaciones por correo en caso de error</li>
<li>Resultados de las pruebas</li>
<li>Artefactos compilados (JARs, WARs, etc.)</li>
</ul>
</div>
</div></div>

</body>
</html>
